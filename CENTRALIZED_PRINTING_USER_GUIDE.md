# Cell Storage é›†ä¸­å¼æ ‡ç­¾æ‰“å°ç”¨æˆ·æŒ‡å—

## æ¦‚è¿°

é›†ä¸­å¼æ ‡ç­¾æ‰“å°ç³»ç»Ÿå…è®¸ç”¨æˆ·åœ¨ç¡®è®¤å°ç®¡ä½ç½®åè‡ªåŠ¨æ‰“å°æ ‡ç­¾ã€‚æ¯ä¸ªå°ç®¡éƒ½ä¼šè·å¾—åŒ…å«æ‰¹æ¬¡ä¿¡æ¯å’Œå­˜å‚¨ä½ç½®çš„ç‹¬ç«‹æ ‡ç­¾ã€‚

## ğŸ”§ ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·ç•Œé¢ â†’ åç«¯æœåŠ¡å™¨ â†’ æ•°æ®åº“ (æ‰“å°ä»»åŠ¡) â† æ‰“å°æœåŠ¡å™¨ â†’ DYMO æ‰“å°æœº
```

- **å‰ç«¯**: ç”¨æˆ·åˆ›å»ºå°ç®¡å¹¶è¯·æ±‚æ‰“å°æ ‡ç­¾
- **åç«¯**: ç®¡ç†æ•°æ®åº“ä¸­çš„æ‰“å°ä»»åŠ¡é˜Ÿåˆ—
- **æ‰“å°æœåŠ¡å™¨**: ç›‘æ§åç«¯ä»»åŠ¡å¹¶é€šè¿‡DYMOæœåŠ¡æ‰“å°æ ‡ç­¾
- **DYMOæœåŠ¡**: æ§åˆ¶æ‰“å°æœºçš„æœ¬åœ°DYMOæ ‡ç­¾è½¯ä»¶

## ğŸ“‹ ä½¿ç”¨æµç¨‹

### 1. åˆ›å»ºå°ç®¡å¹¶é€‰æ‹©æ‰“å°

1. åœ¨Cell Storageç³»ç»Ÿä¸­ï¼Œè¿›å…¥"Add CryoVial(s)"é¡µé¢
2. å¡«å†™æ‰¹æ¬¡ä¿¡æ¯ï¼ˆæ‰¹æ¬¡åç§°ã€ç»†èƒç³»ã€é€šé“æ•°ç­‰ï¼‰
3. é€‰æ‹©è¦æ·»åŠ çš„å°ç®¡æ•°é‡
4. ç‚¹å‡»"Submit"æäº¤è¡¨å•

### 2. ç¡®è®¤ä½ç½®å¹¶è¯·æ±‚æ‰“å°

1. ç³»ç»Ÿæ˜¾ç¤º"Confirm Vial Placement"é¡µé¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰å°ç®¡çš„é¢„å®šä½ç½®
2. æ£€æŸ¥ä½ç½®åˆ†é…æ˜¯å¦æ­£ç¡®
3. ç‚¹å‡»"Confirm and Save These X Vial(s)"
4. åœ¨å¼¹å‡ºçš„ç¡®è®¤å¯¹è¯æ¡†ä¸­ï¼Œ**å‹¾é€‰"Print vial labels after saving"**
5. ç‚¹å‡»"Save Vials"

### 3. æŸ¥çœ‹æ‰“å°é€‰é¡¹

ç³»ç»Ÿä¿å­˜å°ç®¡åï¼Œä¼šæ˜¾ç¤ºæˆåŠŸé¡µé¢ï¼Œå¹¶è‡ªåŠ¨å¼¹å‡º"Print Label"æ¨¡æ€æ¡†ï¼ŒåŒ…å«ï¼š

- **æ‰¹æ¬¡ä¿¡æ¯**: æ‰¹æ¬¡åç§°ã€æ‰¹æ¬¡IDã€å°ç®¡æ•°é‡
- **æœåŠ¡çŠ¶æ€**: æ˜¾ç¤ºæ‰“å°æœåŠ¡æ˜¯å¦å¯ç”¨
- **å°ç®¡åˆ—è¡¨**: æ¯ä¸ªå°ç®¡çš„ä½ç½®å’Œæ‰“å°çŠ¶æ€

### 4. æ‰§è¡Œæ‰“å°

åœ¨Print Labelæ¨¡æ€æ¡†ä¸­ï¼Œæ‚¨å¯ä»¥ï¼š

- **æ‰“å°æ‰€æœ‰æ ‡ç­¾**: ç‚¹å‡»"Print All Labels"æŒ‰é’®
- **æ‰“å°å•ä¸ªæ ‡ç­¾**: ç‚¹å‡»ç‰¹å®šå°ç®¡è¡Œçš„"Print"æŒ‰é’®
- **æŸ¥çœ‹æ‰“å°è¿›åº¦**: å®æ—¶æŸ¥çœ‹æ¯ä¸ªæ‰“å°ä»»åŠ¡çš„çŠ¶æ€

### 5. ç›‘æ§æ‰“å°çŠ¶æ€

æ¯ä¸ªæ‰“å°ä»»åŠ¡ä¼šæ˜¾ç¤ºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š
- **Ready**: å‡†å¤‡æ‰“å°
- **Printing...**: æ­£åœ¨æ‰“å°
- **Job #X queued**: å·²åŠ å…¥æ‰“å°é˜Ÿåˆ—
- **Print failed**: æ‰“å°å¤±è´¥

## ğŸ·ï¸ æ ‡ç­¾å†…å®¹

æ¯ä¸ªå°ç®¡æ ‡ç­¾åŒ…å«ï¼š

```
æ‰¹æ¬¡åç§° (ç²—ä½“)
BXX - Vial N (ç²—ä½“ï¼Œå¤§å­—ä½“)
Tower/Drawer/Box (å­˜å‚¨ä½ç½®)
Position: RXC (è¡Œåˆ—ä½ç½®)     æ—¥æœŸ
```

ç¤ºä¾‹ï¼š
```
HEK293 Transfection
B123 - Vial 2
Tower1/Drawer2/Box3
Position: R2C3        2024-01-15
```

## âš™ï¸ ç®¡ç†å‘˜è®¾ç½®

### å¯ç”¨é›†ä¸­å¼æ‰“å°

åœ¨åç«¯é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š
```python
# config.py
CENTRALIZED_PRINTING_ENABLED = True
```

### æ•°æ®åº“è¿ç§»

æ·»åŠ æ‰“å°ç›¸å…³è¡¨ï¼š
```bash
# åœ¨Flaskåº”ç”¨ç›®å½•ä¸­è¿è¡Œ
python -c "
from app import create_app, db
app = create_app()
with app.app_context():
    db.create_all()
    print('Print tables created successfully')
"
```

### æ‰“å°æœåŠ¡å™¨è®¾ç½®

1. **å®‰è£…æ‰“å°æœåŠ¡å™¨**:
```bash
cd dymo-print-server-nodejs
npm install
```

2. **é…ç½®ç¯å¢ƒå˜é‡**:
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®åç«¯URLå’ŒAPIä»¤ç‰Œ
```

3. **å¯åŠ¨æ‰“å°æœåŠ¡å™¨**:
```bash
npm start
```

## ğŸ” æ•…éšœæ’é™¤

### ç”¨æˆ·ç«¯é—®é¢˜

#### æ²¡æœ‰çœ‹åˆ°æ‰“å°é€‰é¡¹
**é—®é¢˜**: ç¡®è®¤é¡µé¢æ²¡æœ‰æ‰“å°å¤é€‰æ¡†

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤ç®¡ç†å‘˜å·²å¯ç”¨é›†ä¸­å¼æ‰“å°
- æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œæ­£å¸¸
- è”ç³»ç®¡ç†å‘˜æ£€æŸ¥é…ç½®

#### æ‰“å°æ¨¡æ€æ¡†æ˜¾ç¤º"æœåŠ¡ä¸å¯ç”¨"
**é—®é¢˜**: Print Labelæ¨¡æ€æ¡†æ˜¾ç¤ºæ‰“å°æœåŠ¡ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**:
- ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•
- è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æ‰“å°æœåŠ¡å™¨çŠ¶æ€
- å¯ä»¥ç¨åæ‰‹åŠ¨æ‰“å°æ ‡ç­¾

#### æ‰“å°ä»»åŠ¡å¤±è´¥
**é—®é¢˜**: å•ä¸ªæ‰“å°ä»»åŠ¡æ˜¾ç¤º"Print failed"

**è§£å†³æ–¹æ¡ˆ**:
- ç‚¹å‡»è¯¥è¡Œçš„"Print"æŒ‰é’®é‡è¯•
- æ£€æŸ¥å®éªŒå®¤æ‰“å°æœºæ˜¯å¦æœ‰çº¸
- è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æ‰“å°æœºçŠ¶æ€

### ç®¡ç†å‘˜æ•…éšœæ’é™¤

#### æ‰“å°æœåŠ¡å™¨æ— æ³•è¿æ¥åç«¯
```bash
# æ£€æŸ¥é…ç½®
cat dymo-print-server-nodejs/.env

# æ£€æŸ¥åç«¯URLæ˜¯å¦æ­£ç¡®
curl http://your-backend-url:5000/api/print/status

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f dymo-print-server-nodejs/logs/print-server.log
```

#### DYMOæ‰“å°æœºæœªæ‰¾åˆ°
```bash
# æµ‹è¯•DYMOæœåŠ¡
curl http://127.0.0.1:41951/DYMO/DLS/Printing/StatusConnected

# åˆ—å‡ºå¯ç”¨æ‰“å°æœº
curl http://127.0.0.1:41951/DYMO/DLS/Printing/GetPrinters

# æ£€æŸ¥æ‰“å°æœºåç§°é…ç½®
grep PRINTER_NAME dymo-print-server-nodejs/.env
```

#### æ•°æ®åº“ä¸­æ‰“å°ä»»åŠ¡ç§¯å‹
```python
# åœ¨Flask shellä¸­æ£€æŸ¥
from app.cell_storage.models import PrintJob
pending_jobs = PrintJob.query.filter_by(status='pending').all()
print(f"Pending jobs: {len(pending_jobs)}")

# æ£€æŸ¥å¤±è´¥çš„ä»»åŠ¡
failed_jobs = PrintJob.query.filter_by(status='failed').all()
for job in failed_jobs:
    print(f"Job {job.id}: {job.error_message}")
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ£€æŸ¥ç³»ç»ŸçŠ¶æ€

1. **åç«¯APIçŠ¶æ€**:
```bash
curl http://your-backend:5000/api/print/status
```

2. **æ‰“å°æœåŠ¡å™¨çŠ¶æ€**:
```bash
curl http://print-server:3001/api/status
```

3. **æ•°æ®åº“ç»Ÿè®¡**:
```python
from app.cell_storage.models import PrintJob, PrintServer

# ä»»åŠ¡ç»Ÿè®¡
total = PrintJob.query.count()
pending = PrintJob.query.filter_by(status='pending').count()
completed = PrintJob.query.filter_by(status='completed').count()
failed = PrintJob.query.filter_by(status='failed').count()

print(f"æ€»ä»»åŠ¡: {total}, å¾…å¤„ç†: {pending}, å·²å®Œæˆ: {completed}, å¤±è´¥: {failed}")

# æœåŠ¡å™¨ç»Ÿè®¡
servers = PrintServer.query.all()
online_servers = [s for s in servers if s.is_online]
print(f"åœ¨çº¿æœåŠ¡å™¨: {len(online_servers)}/{len(servers)}")
```

### å®šæœŸç»´æŠ¤

1. **æ¸…ç†æ—§ä»»åŠ¡** (å¯é€‰):
```python
from datetime import datetime, timedelta
from app.cell_storage.models import PrintJob
from app import db

# åˆ é™¤30å¤©å‰çš„å·²å®Œæˆ/å¤±è´¥ä»»åŠ¡
cutoff_date = datetime.utcnow() - timedelta(days=30)
old_jobs = PrintJob.query.filter(
    PrintJob.status.in_(['completed', 'failed']),
    PrintJob.created_at < cutoff_date
).all()

for job in old_jobs:
    db.session.delete(job)
db.session.commit()
print(f"Cleaned up {len(old_jobs)} old jobs")
```

2. **æ—¥å¿—è½®è½¬**:
```bash
# é…ç½®logrotateæˆ–æ‰‹åŠ¨æ¸…ç†
find dymo-print-server-nodejs/logs -name "*.log" -mtime +30 -delete
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰æ ‡ç­¾æ¨¡æ¿

ä¿®æ”¹ `dymo-print-server-nodejs/src/dymo-service.js` ä¸­çš„ `generateVialLabelXml` å‡½æ•°æ¥è‡ªå®šä¹‰æ ‡ç­¾å¸ƒå±€ã€‚

### æ‰“å°ä¼˜å…ˆçº§

æ”¯æŒå››ç§ä¼˜å…ˆçº§ï¼š
- `urgent`: ç´§æ€¥
- `high`: é«˜
- `normal`: æ™®é€š (é»˜è®¤)
- `low`: ä½

### æ‰¹é‡æ“ä½œ

ç®¡ç†å‘˜å¯ä»¥é€šè¿‡æ•°æ®åº“æ‰¹é‡æ“ä½œæ‰“å°ä»»åŠ¡ï¼š

```python
# é‡ç½®å¤±è´¥çš„ä»»åŠ¡
failed_jobs = PrintJob.query.filter_by(status='failed').all()
for job in failed_jobs:
    job.status = 'pending'
    job.retry_count = 0
    job.error_message = None
db.session.commit()
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»ä¿¡æ¯
- ç³»ç»Ÿç®¡ç†å‘˜: [ç®¡ç†å‘˜è”ç³»æ–¹å¼]
- æŠ€æœ¯æ”¯æŒ: [æŠ€æœ¯æ”¯æŒè”ç³»æ–¹å¼]

### å¸¸ç”¨å‘½ä»¤
```bash
# æ£€æŸ¥æ‰“å°æœåŠ¡å™¨çŠ¶æ€
curl http://print-server:3001/api/status

# æµ‹è¯•æ‰“å° (è­¦å‘Šï¼šä¼šæ‰“å°å®é™…æ ‡ç­¾!)
curl -X POST http://print-server:3001/api/test-print

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f dymo-print-server-nodejs/logs/print-server.log

# é‡å¯æ‰“å°æœåŠ¡å™¨
# åœ¨æ‰“å°æœåŠ¡å™¨ç›®å½•ä¸­æŒ‰ Ctrl+C åœæ­¢ï¼Œç„¶åè¿è¡Œï¼š
npm start
```

### åº”æ€¥å¤„ç†

å¦‚æœé›†ä¸­å¼æ‰“å°ä¸å¯ç”¨ï¼š
1. ç”¨æˆ·å¯ä»¥å…ˆä¿å­˜å°ç®¡ï¼Œç¨åå†æ‰“å°
2. ç®¡ç†å‘˜å¯ä»¥ä»æ•°æ®åº“å¯¼å‡ºæ ‡ç­¾æ•°æ®æ‰‹åŠ¨æ‰“å°
3. ç³»ç»Ÿä»ç„¶æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯æ²¡æœ‰è‡ªåŠ¨æ‰“å°åŠŸèƒ½

---

æœ‰å…³è¯¦ç»†æŠ€æœ¯ä¿¡æ¯ï¼Œè¯·å‚é˜… `dymo-print-server-nodejs/README.md`ã€‚