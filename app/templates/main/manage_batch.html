{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Manage Batch: {{ batch.name }} <span class="text-muted fs-5">(ID: {{ batch.id }})</span></h1>
    <a href="{{ url_for('cell_storage.manage_batch_lookup') }}" class="btn btn-secondary">Back to Lookup</a>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-3" id="batchTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
            <i class="bi bi-pencil-square me-2"></i>Details & Vials
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="lineage-tab" data-bs-toggle="tab" data-bs-target="#lineage" type="button" role="tab" aria-controls="lineage" aria-selected="false">
            <i class="bi bi-diagram-3 me-2"></i>History Tree
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="batchTabsContent">
    <!-- Details Tab -->
    <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="row">
            <!-- Edit Form Column -->
            <div class="col-lg-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">Edit Batch Details</h5>
            </div>
            <div class="card-body">
                <form method="post">
                  {{ form.hidden_tag() }}
                  <div class="row g-3">
                    <div class="col-12">
                      <div class="form-floating">
                        {{ form.batch_name(class="form-control" + (" is-invalid" if form.batch_name.errors else ""), placeholder="Batch Name") }}
                        {{ form.batch_name.label }}
                        {% if form.batch_name.errors %}<div class="invalid-feedback">{{ form.batch_name.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-floating">
                        {{ form.cell_line_id(class="form-select" + (" is-invalid" if form.cell_line_id.errors else "")) }}
                        {{ form.cell_line_id.label }}
                        {% if form.cell_line_id.errors %}<div class="invalid-feedback">{{ form.cell_line_id.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.passage_number(class="form-control" + (" is-invalid" if form.passage_number.errors else ""), placeholder="Passage Number") }}
                        {{ form.passage_number.label }}
                        {% if form.passage_number.errors %}<div class="invalid-feedback">{{ form.passage_number.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.date_frozen(class="form-control" + (" is-invalid" if form.date_frozen.errors else ""), placeholder="Date Frozen") }}
                        {{ form.date_frozen.label }}
                        {% if form.date_frozen.errors %}<div class="invalid-feedback">{{ form.date_frozen.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.volume_ml(class="form-control" + (" is-invalid" if form.volume_ml.errors else ""), placeholder="Volume (uL)") }}
                        {{ form.volume_ml.label }}
                        {% if form.volume_ml.errors %}<div class="invalid-feedback">{{ form.volume_ml.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.concentration(class="form-control" + (" is-invalid" if form.concentration.errors else ""), placeholder="Concentration") }}
                        {{ form.concentration.label }}
                        {% if form.concentration.errors %}<div class="invalid-feedback">{{ form.concentration.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.fluorescence_tag(class="form-control" + (" is-invalid" if form.fluorescence_tag.errors else ""), placeholder="Fluorescence Tag") }}
                        {{ form.fluorescence_tag.label }}
                        {% if form.fluorescence_tag.errors %}<div class="invalid-feedback">{{ form.fluorescence_tag.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        {{ form.parental_cell_line(class="form-control" + (" is-invalid" if form.parental_cell_line.errors else ""), placeholder="Parental Cell Line") }}
                        {{ form.parental_cell_line.label }}
                        {% if form.parental_cell_line.errors %}<div class="invalid-feedback">{{ form.parental_cell_line.errors[0] }}</div>{% endif %}
                      </div>
                    </div>
                    <div class="col-12">
                      <label class="form-label">{{ form.resistance.label }}</label>
                      <div>
                        {% for sub in form.resistance %}
                        <div class="form-check form-check-inline">
                          {{ sub(class="form-check-input" + (" is-invalid" if form.resistance.errors else "")) }}
                          {{ sub.label(class="form-check-label") }}
                        </div>
                        {% endfor %}
                      </div>
                      {% if form.resistance.errors %}<div class="invalid-feedback d-block">{{ form.resistance.errors[0] }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                      <div class="form-floating">
                        {{ form.notes(class="form-control", rows=3, placeholder="Notes", style="height: 100px;") }}
                        {{ form.notes.label }}
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end mt-4">
                    <button type="submit" name="delete_batch" class="btn btn-danger me-2" onclick="return confirm('Are you sure you want to delete this entire batch and all its vials? This action cannot be undone.');">Delete Batch</button>
                    <button type="submit" name="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
                  </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Vials Visualization Column -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Vials in this Batch</h5>
            </div>
            <div class="card-body">
                {% for box in boxes.values() %}
                  <div class="mb-4">
                    <h6>{{ box.box.drawer_info.tower_info.name }} / {{ box.box.drawer_info.name }} / {{ box.box.name }}</h6>
                    <div class="table-responsive">
                        <table class="box-grid">
                          {% for r in range(1, box.rows + 1) %}
                          <tr>
                            {% for c in range(1, box.columns + 1) %}
                              {% set vial = box.cells.get((r,c)) %}
                              <td class="box-cell status-{{ vial.status.lower() if vial else 'empty' }}" 
                                  title="Vial: {{ vial.unique_vial_id_tag if vial else 'N/A' }}\nStatus: {{ vial.status if vial else 'Empty' }}">
                                {% if vial %}
                                  <a href="{{ url_for('cell_storage.edit_cryovial', vial_id=vial.id, next=request.url) }}" class="vial-link">{{ vial.unique_vial_id_tag }}</a>
                                {% else %}
                                  &nbsp;
                                {% endif %}
                              </td>
                            {% endfor %}
                          </tr>
                          {% endfor %}
                        </table>
                    </div>
                  </div>
                {% else %}
                  <p class="text-muted">No vials from this batch are currently placed in any box.</p>
                {% endfor %}
            </div>
        </div>
        </div>
    </div>
    
    <!-- History Tree Tab -->
    <div class="tab-pane fade" id="lineage" role="tabpanel" aria-labelledby="lineage-tab">
        <div class="row">
            <!-- Lineage Tree Visualization -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3 me-2"></i>Batch History Tree
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="refreshLineage()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-outline-info" onclick="expandAll()">
                                <i class="bi bi-arrows-expand"></i> Expand All
                            </button>
                            <button class="btn btn-outline-secondary" onclick="collapseAll()">
                                <i class="bi bi-arrows-collapse"></i> Collapse All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading Indicator -->
                        <div id="lineage-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading lineage...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading batch history tree...</p>
                        </div>
                        
                        <!-- No Lineage Message -->
                        <div id="no-lineage" class="text-center py-4" style="display: none;">
                            <i class="bi bi-info-circle text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">No History Tree Available</h5>
                            <p class="text-muted">This batch has no recorded parental relationships.</p>
                        </div>
                        
                        <!-- Lineage Statistics -->
                        <div id="lineage-stats" class="mb-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="bg-light p-3 rounded text-center">
                                        <div class="h4 mb-1 text-primary" id="ancestor-count">0</div>
                                        <small class="text-muted">Ancestors</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="bg-light p-3 rounded text-center">
                                        <div class="h4 mb-1 text-success" id="descendant-count">0</div>
                                        <small class="text-muted">Descendants</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="bg-light p-3 rounded text-center">
                                        <div class="h4 mb-1 text-info" id="generation-span">0</div>
                                        <small class="text-muted">Generation Span</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="bg-light p-3 rounded text-center">
                                        <div class="h4 mb-1 text-warning" id="total-related">0</div>
                                        <small class="text-muted">Total Related</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lineage Tree Container -->
                        <div id="lineage-tree" style="display: none;">
                            <!-- Ancestors Section -->
                            <div id="ancestors-section" class="mb-4">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-arrow-up-circle me-2"></i>Ancestors (Parent Batches)
                                </h6>
                                <div id="ancestors-tree"></div>
                            </div>
                            
                            <!-- Current Batch Section -->
                            <div class="current-batch-section mb-4">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-circle-fill me-2"></i>Current Batch
                                </h6>
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 class="card-title mb-1">{{ batch.name }}</h5>
                                                <p class="card-text mb-2">
                                                    <strong>Cell Line:</strong> {{ batch.cell_line }}<br>
                                                    <strong>Passage:</strong> {{ batch.passage_number or 'N/A' }}<br>
                                                    <strong>Date Frozen:</strong> {{ batch.date_frozen.strftime('%Y-%m-%d') if batch.date_frozen else 'N/A' }}
                                                </p>
                                                {% if batch.parental_cell_line %}
                                                <small><strong>Parental Line:</strong> {{ batch.parental_cell_line }}</small>
                                                {% endif %}
                                            </div>
                                            <span class="badge bg-light text-dark">ID: {{ batch.id }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Descendants Section -->
                            <div id="descendants-section">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-arrow-down-circle me-2"></i>Descendants (Child Batches)
                                </h6>
                                <div id="descendants-tree"></div>
                            </div>
                        </div>
                        
                        <!-- Lineage Validation -->
                        <div id="lineage-validation" class="mt-4" style="display: none;">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-check-circle me-2"></i>Lineage Validation
                            </h6>
                            <div id="validation-results"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lineage Tree JavaScript -->
<script>
let currentBatchId = {{ batch.id }};
let lineageData = null;

// 页面加载时初始化lineage选项卡
document.addEventListener('DOMContentLoaded', function() {
    // 监听选项卡切换事件
    const lineageTab = document.getElementById('lineage-tab');
    lineageTab.addEventListener('shown.bs.tab', function() {
        loadLineageData();
    });
});

// 加载lineage数据
async function loadLineageData() {
    try {
        showLoading();
        
        // 并行加载lineage和统计数据
        const [lineageResponse, statsResponse] = await Promise.all([
            fetch(`/api/batch/${currentBatchId}/lineage`),
            fetch(`/api/batch/${currentBatchId}/lineage/statistics`)
        ]);
        
        if (!lineageResponse.ok || !statsResponse.ok) {
            throw new Error('Failed to load lineage data');
        }
        
        const lineageResult = await lineageResponse.json();
        const statsResult = await statsResponse.json();
        
        if (lineageResult.success && statsResult.success) {
            lineageData = lineageResult.lineage;
            displayLineage(lineageData);
            displayStatistics(statsResult.statistics);
            
            // 如果有lineage数据，也加载验证信息
            if (lineageData.has_lineage) {
                loadValidationData();
            }
        } else {
            throw new Error('API returned error');
        }
        
    } catch (error) {
        console.error('Error loading lineage data:', error);
        showError('Failed to load batch history tree');
    }
}

// 显示加载状态
function showLoading() {
    document.getElementById('lineage-loading').style.display = 'block';
    document.getElementById('no-lineage').style.display = 'none';
    document.getElementById('lineage-stats').style.display = 'none';
    document.getElementById('lineage-tree').style.display = 'none';
    document.getElementById('lineage-validation').style.display = 'none';
}

// 显示lineage数据
function displayLineage(data) {
    document.getElementById('lineage-loading').style.display = 'none';
    
    if (!data.has_lineage) {
        document.getElementById('no-lineage').style.display = 'block';
        return;
    }
    
    document.getElementById('lineage-tree').style.display = 'block';
    
    // 渲染祖先树
    renderTree(data.ancestors, 'ancestors-tree', 'ancestor');
    
    // 渲染后代树
    renderTree(data.descendants, 'descendants-tree', 'descendant');
}

// 显示统计数据
function displayStatistics(stats) {
    if (!stats.has_lineage) return;
    
    document.getElementById('lineage-stats').style.display = 'block';
    document.getElementById('ancestor-count').textContent = stats.ancestor_count;
    document.getElementById('descendant-count').textContent = stats.descendant_count;
    document.getElementById('generation-span').textContent = stats.generation_span;
    document.getElementById('total-related').textContent = stats.total_related_batches;
}

// 渲染树结构
function renderTree(nodes, containerId, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (!nodes || nodes.length === 0) {
        container.innerHTML = '<p class="text-muted font-italic">No ' + type + 's found</p>';
        return;
    }
    
    nodes.forEach(node => {
        const nodeElement = createNodeElement(node, type);
        container.appendChild(nodeElement);
    });
}

// 创建节点元素
function createNodeElement(node, type) {
    const div = document.createElement('div');
    div.className = 'batch-node mb-3';
    div.innerHTML = `
        <div class="card border-${getNodeColor(type)}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title mb-2">
                            <a href="/admin/manage_batch/${node.id}" class="text-decoration-none">
                                ${node.name}
                            </a>
                            ${node.depth > 0 ? `<small class="text-muted">(Depth: ${node.depth})</small>` : ''}
                        </h6>
                        <p class="card-text small mb-2">
                            <strong>Cell Line:</strong> ${node.cell_line}<br>
                            <strong>Passage:</strong> ${node.passage_number || 'N/A'}<br>
                            <strong>Date:</strong> ${node.date_frozen ? new Date(node.date_frozen).toLocaleDateString() : 'N/A'}
                        </p>
                        ${node.parental_cell_line ? `<small class="text-muted">Parental: ${node.parental_cell_line}</small>` : ''}
                    </div>
                    <span class="badge bg-${getNodeColor(type)}">ID: ${node.id}</span>
                </div>
                ${renderChildNodes(node, type)}
            </div>
        </div>
    `;
    
    return div;
}

// 渲染子节点
function renderChildNodes(node, type) {
    const childrenKey = type === 'ancestor' ? 'parents' : 'children';
    const children = node[childrenKey];
    
    if (!children || children.length === 0) {
        return '';
    }
    
    let html = `<div class="mt-3 ms-3 border-start border-2 border-${getNodeColor(type)} ps-3">`;
    children.forEach(child => {
        html += createNodeElement(child, type).outerHTML;
    });
    html += '</div>';
    
    return html;
}

// 获取节点颜色
function getNodeColor(type) {
    switch(type) {
        case 'ancestor': return 'info';
        case 'descendant': return 'success';
        default: return 'secondary';
    }
}

// 加载验证数据
async function loadValidationData() {
    try {
        const response = await fetch(`/api/batch/${currentBatchId}/lineage/validate`);
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayValidation(result.validation);
            }
        }
    } catch (error) {
        console.error('Error loading validation data:', error);
    }
}

// 显示验证结果
function displayValidation(validation) {
    document.getElementById('lineage-validation').style.display = 'block';
    
    const container = document.getElementById('validation-results');
    let html = '';
    
    if (validation.is_valid) {
        html += '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Lineage validation passed successfully</div>';
    } else {
        html += '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Lineage validation failed</div>';
    }
    
    if (validation.issues.length > 0) {
        html += '<div class="alert alert-danger"><strong>Issues:</strong><ul class="mb-0">';
        validation.issues.forEach(issue => {
            html += `<li>${issue}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (validation.warnings.length > 0) {
        html += '<div class="alert alert-warning"><strong>Warnings:</strong><ul class="mb-0">';
        validation.warnings.forEach(warning => {
            html += `<li>${warning}</li>`;
        });
        html += '</ul></div>';
    }
    
    container.innerHTML = html;
}

// 工具函数
function refreshLineage() {
    loadLineageData();
}

function expandAll() {
    // 实现展开所有节点
    document.querySelectorAll('.batch-node .collapse').forEach(el => {
        el.classList.add('show');
    });
}

function collapseAll() {
    // 实现收起所有节点
    document.querySelectorAll('.batch-node .collapse').forEach(el => {
        el.classList.remove('show');
    });
}

function showError(message) {
    document.getElementById('lineage-loading').style.display = 'none';
    // 可以添加错误显示逻辑
    console.error(message);
}
</script>

<style>
.batch-node {
    transition: all 0.3s ease;
}

.batch-node:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.current-batch-section .card {
    position: relative;
    overflow: hidden;
}

.current-batch-section .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #fff, rgba(255,255,255,0.5), #fff);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

#ancestors-tree .card, #descendants-tree .card {
    border-left-width: 4px !important;
}

.tab-content {
    min-height: 500px;
}
</style>
{% endblock %}
