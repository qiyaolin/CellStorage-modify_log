{% extends "mobile/base.html" %}

{% block title %}CellStorage Mobile - Locations{% endblock %}
{% block page_title %}Storage Locations{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <!-- Overview Stats -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card card-mobile bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="mb-0">Storage Overview</h5>
                    <small>{{ location_data|length }} Tower(s) Available</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Data -->
    {% if location_data %}
        {% for tower in location_data %}
        <div class="card card-mobile mb-3">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-building me-2"></i>Tower: {{ tower.name }}
                    </h6>
                    <span class="badge bg-light text-dark">{{ tower.drawers|length }} drawer(s)</span>
                </div>
            </div>
            
            {% for drawer in tower.drawers %}
            <div class="card-body border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-inbox me-2"></i>Drawer: {{ drawer.name }}
                    </h6>
                    <span class="badge bg-secondary">{{ drawer.boxes|length }} box(es)</span>
                </div>
                
                {% if drawer.boxes %}
                <div class="accordion mb-3" id="drawer-{{ tower.name|replace(' ', '-') }}-{{ drawer.name|replace(' ', '-') }}">
                    {% for box in drawer.boxes %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#box-{{ box.id }}" 
                                    aria-expanded="false">
                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                    <div>
                                        <strong>{{ box.name }}</strong>
                                        <small class="text-muted ms-2">{{ box.occupied }}/{{ box.total }} ({{ "%.0f"|format(box.occupancy_rate) }}%)</small>
                                    </div>
                                    <div class="progress me-2" style="width: 60px; height: 8px;">
                                        <div class="progress-bar 
                                            {% if box.occupancy_rate >= 80 %}bg-danger
                                            {% elif box.occupancy_rate >= 60 %}bg-warning
                                            {% else %}bg-success{% endif %}" 
                                             style="width: {{ box.occupancy_rate }}%">
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="box-{{ box.id }}" class="accordion-collapse collapse" data-box-id="{{ box.id }}">
                            <div class="accordion-body">
                                <!-- Loading indicator -->
                                <div class="box-loading-indicator" id="loading-{{ box.id }}">
                                    <div class="text-center p-4">
                                        <div class="loading-spinner me-2"></div>
                                        <span class="text-muted">Loading box contents...</span>
                                    </div>
                                </div>
                                
                                <!-- Error state -->
                                <div class="box-error-state d-none" id="error-{{ box.id }}">
                                    <div class="text-center p-4">
                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                        <span class="text-muted">Failed to load box contents</span>
                                        <br>
                                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadBoxDetails({{ box.id }})">
                                            <i class="fas fa-redo me-1"></i>Retry
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Box content (will be populated via AJAX) -->
                                <div class="box-content d-none" id="content-{{ box.id }}">
                                    <!-- Content will be inserted here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No boxes in this drawer</p>
                {% endif %}
            </div>
            {% endfor %}
            
            {% if not tower.drawers %}
            <div class="card-body">
                <p class="text-muted mb-0">No drawers in this tower</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
    <!-- No locations message -->
    <div class="card card-mobile">
        <div class="card-body text-center p-4">
            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
            <h6>No Storage Locations</h6>
            <p class="text-muted">No storage locations have been configured yet.</p>
            {% if current_user.is_admin %}
            <a href="{{ url_for('cell_storage.locations_overview') }}" class="btn btn-primary btn-mobile">
                Configure Locations
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Legend -->
    <div class="card card-mobile mt-3">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>Occupancy Legend
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-success" style="width: 20px; height: 10px; border-radius: 2px;"></div>
                        <small class="ms-2">0-59%</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning" style="width: 20px; height: 10px; border-radius: 2px;"></div>
                        <small class="ms-2">60-79%</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger" style="width: 20px; height: 10px; border-radius: 2px;"></div>
                        <small class="ms-2">80-100%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card card-mobile mt-3">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-bolt me-2"></i>Quick Actions
            </h6>
        </div>
        <div class="card-body">
            <div class="d-grid gap-2">
                <a href="{{ url_for('mobile.cryovial_inventory') }}" class="btn btn-outline-primary btn-mobile">
                    <i class="fas fa-vials me-2"></i>View Inventory
                </a>
                <a href="{{ url_for('mobile.quick_search') }}" class="btn btn-outline-success btn-mobile">
                    <i class="fas fa-search me-2"></i>Search Vials
                </a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('cell_storage.locations_overview') }}" class="btn btn-outline-warning btn-mobile">
                    <i class="fas fa-cogs me-2"></i>Manage Locations
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Mobile Vial Details Modal -->
    <div class="modal fade" id="mobileVialModal" tabindex="-1" aria-labelledby="mobileVialModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="mobileVialModalLabel">
                        <i class="fas fa-vial"></i> Vial Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="card">
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-4">Vial ID:</dt>
                                <dd class="col-sm-8" id="modal-vial-tag">-</dd>
                                
                                <dt class="col-sm-4">Batch:</dt>
                                <dd class="col-sm-8" id="modal-batch-name">-</dd>
                                
                                <dt class="col-sm-4">Cell Line:</dt>
                                <dd class="col-sm-8" id="modal-cell-line">-</dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8" id="modal-status">-</dd>
                                
                                <dt class="col-sm-4">Position:</dt>
                                <dd class="col-sm-8" id="modal-position">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="view-in-inventory-btn">
                        <i class="fas fa-search"></i> View in Inventory
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cache for loaded box data
const loadedBoxes = new Set();
const boxDataCache = new Map();

document.addEventListener('DOMContentLoaded', function() {
    // Add touch feedback for box cards
    document.querySelectorAll('.card .card-body').forEach(function(card) {
        card.addEventListener('touchstart', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        card.addEventListener('touchend', function() {
            setTimeout(() => {
                this.style.backgroundColor = '';
            }, 150);
        });
    });
    
    // Animate progress bars on load
    setTimeout(() => {
        document.querySelectorAll('.progress-bar').forEach(function(bar) {
            const width = bar.style.width;
            bar.style.width = '0%';
            bar.style.transition = 'width 1s ease-in-out';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 300);
    
    // Handle accordion expand events for lazy loading
    document.querySelectorAll('.accordion-collapse').forEach(function(accordion) {
        accordion.addEventListener('show.bs.collapse', function() {
            const boxId = this.getAttribute('data-box-id');
            if (boxId && !loadedBoxes.has(boxId)) {
                loadBoxDetails(boxId);
            }
        });
    });
    
    // Handle vial modal
    const vialModal = document.getElementById('mobileVialModal');
    let currentVialId = null;
    
    // Use event delegation for dynamically loaded vial cells
    document.addEventListener('click', function(event) {
        if (event.target.closest('[data-vial-id]')) {
            const button = event.target.closest('[data-vial-id]');
            
            // Extract data from the clicked cell
            currentVialId = button.getAttribute('data-vial-id');
            const vialTag = button.getAttribute('data-vial-tag');
            const batchName = button.getAttribute('data-batch-name');
            const cellLine = button.getAttribute('data-cell-line');
            const status = button.getAttribute('data-status');
            const position = button.getAttribute('data-position');
            
            // Update modal content
            document.getElementById('modal-vial-tag').textContent = vialTag || '-';
            document.getElementById('modal-batch-name').textContent = batchName || '-';
            document.getElementById('modal-cell-line').textContent = cellLine || '-';
            document.getElementById('modal-position').textContent = position || '-';
            
            // Update status with appropriate badge
            const statusElement = document.getElementById('modal-status');
            let statusBadge = '';
            switch (status) {
                case 'Available':
                    statusBadge = '<span class="badge bg-success">Available</span>';
                    break;
                case 'Used':
                    statusBadge = '<span class="badge bg-secondary">Used</span>';
                    break;
                default:
                    statusBadge = `<span class="badge bg-warning">${status}</span>`;
            }
            statusElement.innerHTML = statusBadge;
            
            // Show modal
            const modal = new bootstrap.Modal(vialModal);
            modal.show();
        }
    });
    
    // Handle "View in Inventory" button
    document.getElementById('view-in-inventory-btn').addEventListener('click', function() {
        if (currentVialId) {
            // Close modal and navigate to inventory with search for this vial
            bootstrap.Modal.getInstance(vialModal).hide();
            
            // Navigate to inventory with vial search
            const vialTag = document.getElementById('modal-vial-tag').textContent;
            window.location.href = `{{ url_for('mobile.cryovial_inventory') }}?q=${encodeURIComponent(vialTag)}`;
        }
    });
});

// Function to load box details via AJAX
function loadBoxDetails(boxId) {
    if (loadedBoxes.has(boxId)) {
        return; // Already loaded
    }
    
    const loadingElement = document.getElementById(`loading-${boxId}`);
    const errorElement = document.getElementById(`error-${boxId}`);
    const contentElement = document.getElementById(`content-${boxId}`);
    
    // Show loading state
    loadingElement.classList.remove('d-none');
    errorElement.classList.add('d-none');
    contentElement.classList.add('d-none');
    
    // Make AJAX request
    fetch(`/mobile/api/box/${boxId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cache the data
                boxDataCache.set(boxId, data);
                loadedBoxes.add(boxId);
                
                // Generate and insert the box content
                const content = generateBoxContent(data);
                contentElement.innerHTML = content;
                
                // Show content and hide loading
                loadingElement.classList.add('d-none');
                contentElement.classList.remove('d-none');
            } else {
                throw new Error(data.error || 'Failed to load box details');
            }
        })
        .catch(error => {
            console.error('Error loading box details:', error);
            
            // Show error state
            loadingElement.classList.add('d-none');
            errorElement.classList.remove('d-none');
        });
}

// Function to generate box content HTML
function generateBoxContent(data) {
    if (data.occupied === 0) {
        return '<p class="text-muted mb-0">This box is empty</p>';
    }
    
    let html = '<div class="table-responsive">';
    html += '<table class="table table-bordered table-sm" style="font-size: 0.75rem;">';
    
    // Header
    html += '<thead><tr><th style="width: 30px;">#</th>';
    for (let c = 1; c <= data.columns; c++) {
        html += `<th class="text-center" style="width: 40px;">${c}</th>`;
    }
    html += '</tr></thead>';
    
    // Body
    html += '<tbody>';
    for (let r = 1; r <= data.rows; r++) {
        html += `<tr><th class="text-center bg-light">${r}</th>`;
        for (let c = 1; c <= data.columns; c++) {
            const key = `${r}-${c}`;
            const vial = data.vials[key];
            
            if (vial) {
                html += `<td class="text-center p-1 batch-browse-${vial.batch_color}" 
                            style="cursor: pointer;" 
                            data-vial-id="${vial.id}"
                            data-vial-tag="${vial.tag}"
                            data-batch-name="${vial.batch_name}"
                            data-cell-line="${vial.cell_line}"
                            data-status="${vial.status}"
                            data-position="R${r}C${c}">
                            <small>${vial.batch_id}</small>
                         </td>`;
            } else {
                html += '<td class="text-center p-1" style="background-color: #f8f9fa !important; color: #6c757d !important;">';
                html += '<small class="text-muted">-</small></td>';
            }
        }
        html += '</tr>';
    }
    html += '</tbody></table></div>';
    
    // Legend
    html += '<div class="mt-2">';
    html += '<small class="text-muted">';
    html += '<i class="fas fa-info-circle me-1"></i>';
    html += 'Different colors represent different batches. Click on any vial for details.';
    html += '<span class="badge bg-light text-dark ms-2">Empty positions are gray</span>';
    html += '</small></div>';
    
    return html;
}
</script>
{% endblock %}